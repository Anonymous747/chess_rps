# Database Migrations Guide

This project uses [Alembic](https://alembic.sqlalchemy.org/) for database migrations.

## Setup

1. Install dependencies:
   ```bash
   pip install -r requirements.txt
   ```

2. Ensure your database is running and configured in `env.local`:
   ```
   DB_HOST=localhost
   DB_PORT=5432
   DB_NAME=chess_rps
   DB_USER=postgres
   DB_PASS=chess_rps_password
   ```

## Creating Migrations

When you modify models in `src/auth/models.py` or `src/game/models.py`, create a new migration:

### Windows:
```bash
migrate.bat revision --autogenerate -m "Description of changes"
```

### Linux/Mac:
```bash
chmod +x migrate.sh
./migrate.sh revision --autogenerate -m "Description of changes"
```

### Or use Python directly:
```bash
python -m alembic revision --autogenerate -m "Description of changes"
```

## Applying Migrations

Apply all pending migrations to the database:

### Windows:
```bash
migrate.bat upgrade head
```

### Linux/Mac:
```bash
./migrate.sh upgrade head
```

### Or use Python directly:
```bash
python -m alembic upgrade head
```

## Rolling Back Migrations

Rollback the last migration:

```bash
migrate.bat downgrade -1
# or
./migrate.sh downgrade -1
# or
python -m alembic downgrade -1
```

## Checking Migration Status

View current migration version:

```bash
migrate.bat current
# or
./migrate.sh current
```

View migration history:

```bash
migrate.bat history
# or
./migrate.sh history
```

## Initial Migration

To create the initial migration with all existing models:

```bash
migrate.bat revision --autogenerate -m "Initial migration"
migrate.bat upgrade head
```

## Important Notes

1. **Always review autogenerated migrations** before applying them. Alembic may not detect all changes correctly.

2. **Never edit existing migrations** that have been applied to production. Create new migrations instead.

3. **Backup your database** before running migrations in production.

4. The `main.py` startup event will still create tables if they don't exist (for development). For production, use migrations only.

5. Migrations are stored in `alembic/versions/` directory.

## Troubleshooting

### Migration conflicts
If you have migration conflicts, you can:
- Check current version: `migrate.bat current`
- View history: `migrate.bat history`
- Manually resolve conflicts in migration files

### Database connection issues
- Verify database is running
- Check `env.local` configuration
- Ensure database exists: `createdb chess_rps` (PostgreSQL)

### Models not detected
- Ensure models inherit from `Base` (from `src.database`)
- Import all models in `alembic/env.py`
- Check that models are imported in `main.py`




